<!-- Security Dashboard Tab Content -->
<div class="tab-pane fade" id="security-tab-content" role="tabpanel">
  <h2 class="mb-4">üîí Security Dashboard</h2>
  
  <div id="security-loading" class="text-center py-5">
    <div class="spinner-border text-warning" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3">Loading security data...</p>
  </div>
  
  <div id="security-content" style="display: none;">
    <!-- Stats Cards -->
    <div class="row mb-4" id="security-stats-grid">
      <!-- Stats will be inserted here -->
    </div>
    
    <!-- Blocked IPs -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>üö´ Blocked IPs</strong>
        <button onclick="loadSecurityDashboard()" class="btn btn-sm btn-outline-primary">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-dark table-striped">
            <thead>
              <tr>
                <th>IP Address</th>
                <th>Reason</th>
                <th>Severity</th>
                <th>Blocked At</th>
                <th>Expires At</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="blocked-ips-tbody">
              <tr><td colspan="6" class="text-center">No blocked IPs</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Recent Events -->
    <div class="card">
      <div class="card-header">
        <strong>‚ö†Ô∏è Recent Security Events</strong>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-dark table-striped">
            <thead>
              <tr>
                <th>Time</th>
                <th>Type</th>
                <th>Severity</th>
                <th>IP</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody id="security-events-tbody">
              <tr><td colspan="5" class="text-center">No recent events</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Load security dashboard data
async function loadSecurityDashboard() {
  try {
    // Get token from cookie - try multiple methods
    let token = getCookie('access_token');
    
    // If getCookie doesn't work, try direct cookie access
    if (!token) {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'access_token') {
          token = value;
          break;
        }
      }
    }
    
    if (!token) {
      console.error('No access token found');
      document.getElementById('security-loading').innerHTML = 
        '<div class="alert alert-danger">Authentication error. Please refresh the page and try again.</div>';
      return;
    }
    
    console.log('Token found, loading security data...');
    
    const headers = {
      'Authorization': `Bearer ${token}`
    };
    
    // Show loading
    document.getElementById('security-loading').style.display = 'block';
    document.getElementById('security-content').style.display = 'none';
    
    // Load stats
    const statsRes = await fetch('/api/security/stats', { headers });
    const stats = await statsRes.json();
    
    // Load blocked IPs
    const blockedRes = await fetch('/api/security/blocked-ips', { headers });
    const blocked = await blockedRes.json();
    
    // Load events
    const eventsRes = await fetch('/api/security/events?limit=20', { headers });
    const events = await eventsRes.json();
    
    // Render stats
    renderSecurityStats(stats);
    
    // Render blocked IPs
    renderBlockedIPsTable(blocked.blocked_ips || []);
    
    // Render events
    renderSecurityEvents(events.events || []);
    
    // Hide loading, show content
    document.getElementById('security-loading').style.display = 'none';
    document.getElementById('security-content').style.display = 'block';
    
  } catch (error) {
    console.error('Error loading security dashboard:', error);
    document.getElementById('security-loading').innerHTML = 
      '<div class="alert alert-danger">Error loading security data. Please check your permissions.</div>';
  }
}

function renderSecurityStats(stats) {
  const grid = document.getElementById('security-stats-grid');
  const monitoring = stats.monitoring || {};
  const blocking = stats.blocking || {};
  
  grid.innerHTML = `
    <div class="col-md-3">
      <div class="card bg-danger text-white">
        <div class="card-body">
          <h6>Total Events (24h)</h6>
          <h2>${monitoring.total_events_24h || 0}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-dark">
        <div class="card-body">
          <h6>Critical Events</h6>
          <h2>${monitoring.events_by_severity?.critical || 0}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white">
        <div class="card-body">
          <h6>Blocked IPs</h6>
          <h2>${blocking.active_blocks || 0}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body">
          <h6>Suspicious IPs</h6>
          <h2>${monitoring.suspicious_ips_count || 0}</h2>
        </div>
      </div>
    </div>
  `;
}

function renderBlockedIPsTable(ips) {
  const tbody = document.getElementById('blocked-ips-tbody');
  
  if (!ips || ips.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No blocked IPs</td></tr>';
    return;
  }
  
  tbody.innerHTML = ips.map(ip => `
    <tr>
      <td><strong>${ip.ip}</strong></td>
      <td>${ip.reason}</td>
      <td><span class="badge bg-${getSeverityColor(ip.severity)}">${ip.severity}</span></td>
      <td>${new Date(ip.blocked_at).toLocaleString()}</td>
      <td>${new Date(ip.expires_at).toLocaleString()}</td>
      <td>
        <button class="btn btn-sm btn-success" onclick="unblockIPAddress('${ip.ip}')">
          Unblock
        </button>
      </td>
    </tr>
  `).join('');
}

function renderSecurityEvents(events) {
  const tbody = document.getElementById('security-events-tbody');
  
  if (!events || events.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="text-center">No recent events</td></tr>';
    return;
  }
  
  tbody.innerHTML = events.map(event => `
    <tr>
      <td>${new Date(event.timestamp).toLocaleString()}</td>
      <td>${event.type}</td>
      <td><span class="badge bg-${getSeverityColor(event.severity)}">${event.severity}</span></td>
      <td>${event.ip}</td>
      <td>${JSON.stringify(event.details).substring(0, 100)}...</td>
    </tr>
  `).join('');
}

function getSeverityColor(severity) {
  const colors = {
    'critical': 'danger',
    'high': 'warning',
    'medium': 'info',
    'low': 'success'
  };
  return colors[severity] || 'secondary';
}

async function unblockIPAddress(ip) {
  if (!confirm(`Unblock IP ${ip}?`)) return;
  
  try {
    const token = getCookie('access_token');
    const res = await fetch('/api/security/unblock-ip', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ ip })
    });
    
    if (res.ok) {
      alert(`IP ${ip} unblocked successfully`);
      loadSecurityDashboard();
    } else {
      alert('Failed to unblock IP');
    }
  } catch (error) {
    console.error('Error unblocking IP:', error);
    alert('Error unblocking IP');
  }
}

function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
  return null;
}

// Also try window.getCookie if it exists
if (typeof window.getCookie === 'undefined') {
  window.getCookie = getCookie;
}
</script>
